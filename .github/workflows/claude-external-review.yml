name: Claude PR Review (External - Manual)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number to review'
        required: true
        type: number

jobs:
  external-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ inputs.pr_number }}/head
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ inputs.pr_number }}

            Please review this pull request from an external contributor.
            This is a manually triggered review for a contribution from outside the core team.
            The PR branch is already checked out in the current working directory.

            ## Review Focus Areas

            ### Code Style & Patterns (from CLAUDE.md)
            - ✅ Prefer arrow functions over function declarations
            - ✅ Use `type` over `interface` for type definitions
            - ✅ Avoid unnecessary `any` types - prefer proper TypeScript types or `unknown` with type guards (some intentional `any` usage is acceptable)
            - ✅ PascalCase for types and Zod schema names
            - ✅ Use `test` instead of `it` in test files
            - ✅ Prefer `Bun.resolveSync()` over `path.join()` in Bun environments
            - ✅ Use JSX syntax - avoid `h()` or `createTemplate()` direct calls (internal functions)
            - ⚠️ Correct terminology: "templates" not "components" (except for Web Components API references)

            ### Manual Review Standards (Not Enforced by Biome)
            - ✅ `@ts-ignore` requires description: When using `@ts-ignore`, include a comment explaining why
            - ✅ Short-circuit and ternary expressions are acceptable: `condition && doSomething()` and `condition ? a : b` are idiomatic
            - ✅ Empty object types when extending single interface: `interface Foo extends Bar {}` is acceptable for branded types

            ### Test Coverage
            - `*.spec.{ts,tsx}` - Unit/integration tests required for new functionality
            - `*.stories.tsx` - Browser-based template tests for visual templates
            - Verify appropriate test coverage for changes

            ### Architecture Compliance
            - Behavioral programming patterns: proper use of `behavioral()`, `bThread()`, `bSync()`, `useBehavioral()`
            - Shadow DOM usage with `bElement`
            - CSS-in-JS patterns: proper use of  `createStyles()`, `createHostStyles()`, `createKeyframes()`, `createTokens()`, `joinStyles()`
            - Signal patterns: proper use of `useSignal()`, `useComputed()`

            ### Documentation Requirements
            - TSDoc comments for public APIs
            - No `@example` sections (tests/stories serve as examples)
            - Factory functions only in behavioral documentation
            - Proper type documentation

            ### Critical Checks
            - Security vulnerabilities (XSS, SQL injection, command injection, OWASP top 10)
            - Breaking changes to public APIs
            - License compliance (if adding new dependencies)
            - No backwards-compatibility hacks
            - Unused code should be deleted completely

            ## Review Tone

            Be welcoming and constructive - this is a contribution from outside the core team.
            Provide clear explanations for any requested changes.
            Acknowledge good practices and positive contributions.
            If suggesting changes, explain the reasoning and project standards.

            ## Review Instructions

            1. Use `gh pr view` and `gh pr diff` to examine the changes
            2. Check for compliance with project standards and architecture
            3. Use `mcp__github_inline_comment__create_inline_comment` for specific code issues
            4. Use `gh pr comment` for top-level feedback and summary
            5. Be specific, constructive, and welcoming in feedback
            6. Only post GitHub comments - don't submit review text as messages to me

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
