name: Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version tag (e.g., 1.0.0)'
        required: true
      next:
        description: 'Next prerelease number (optional, will create a version like x.y.z-next.N)'
        required: false
jobs:
  check-release-pr:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      pull-requests: read
    outputs:
      release_pr_merged: ${{ steps.check_pr.outputs.merged }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_NEXT: ${{ github.event.inputs.next }}
        run: |
          # SECURITY: Validate all inputs before use to prevent injection
          # Using env vars instead of direct interpolation to prevent shell injection

          # Validate version format (semver)
          if ! echo "$INPUT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version format: $INPUT_VERSION"
            echo "::error::Expected: X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

          # Validate next is a number if provided
          if [[ -n "$INPUT_NEXT" ]] && ! echo "$INPUT_NEXT" | grep -qE '^[0-9]+$'; then
            echo "::error::Invalid next value: $INPUT_NEXT"
            echo "::error::Expected: number (e.g., 1, 2, 3)"
            exit 1
          fi

          echo "✓ Input validation passed"

      - name: Check for merged release PR
        id: check_pr
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_NEXT: ${{ github.event.inputs.next }}
        run: |
          version="$INPUT_VERSION"
          next="$INPUT_NEXT"

          # Construct expected version
          if [[ -n "$next" ]]; then
            expected_version="${version}-next.${next}"
          else
            expected_version="${version}"
          fi

          echo "Checking for merged release PR for version: $expected_version"

          # Look for merged PR with title matching release version
          # Check last 10 merged PRs
          MERGED_PR=$(gh pr list \
            --state merged \
            --limit 10 \
            --search "Release v${expected_version} in:title" \
            --json number,title,mergedAt \
            --jq '.[0]' || echo "")

          if [ -z "$MERGED_PR" ] || [ "$MERGED_PR" = "null" ]; then
            echo "❌ No merged release PR found for v${expected_version}"
            echo ""
            echo "Before publishing, you must:"
            echo "1. Create a release PR: Run the 'Create Release PR' workflow"
            echo "2. Review and merge the release PR"
            echo "3. Then run this publish workflow"
            echo ""
            echo "This ensures TSDoc is up-to-date before publishing."
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "✅ Found merged release PR:"
            echo "$MERGED_PR" | jq '.'
            echo "merged=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    runs-on: ubuntu-22.04
    needs: check-release-pr
    if: needs.check-release-pr.outputs.release_pr_merged == 'true'
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Set version
        id: set_version
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_NEXT: ${{ github.event.inputs.next }}
        run: |
          base_version="$INPUT_VERSION"
          next="$INPUT_NEXT"

          if [[ -n "$next" ]]; then
            echo "version=${base_version}-next.${next}" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "version=${base_version}" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate version format
        env:
          VERSION: ${{ steps.set_version.outputs.version }}
        run: |
          version="$VERSION"

          # Check for 'v' prefix (common mistake)
          if [[ "$version" =~ ^v ]]; then
            echo "::error::Version should not include 'v' prefix"
            echo "::error::Enter '1.3.4' not 'v1.3.4'"
            echo "::error::The workflow will automatically add 'v' for Git tags"
            exit 1
          fi

          # Validate semver format (allows dots in prerelease suffix for formats like 1.0.0-next.1)
          if [[ ! "$version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-([a-zA-Z0-9._-]+))?$ ]]; then
            echo "::error::Version must have the format 'x.y.z' or 'x.y.z-<string>', where x, y, and z are numbers."
            exit 1
          fi

          echo "✅ Version format validated: $version"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - uses: oven-sh/setup-bun@v1

      - name: Setup
        run: |
          bun install

      - name: Configure Git
        env:
          GIT_AUTHOR_NAME: ${{ github.actor }}
          GIT_AUTHOR_EMAIL: ${{ github.actor }}@users.noreply.github.com
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

      - name: Version
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          VERSION: ${{ steps.set_version.outputs.version }}
          IS_PRERELEASE: ${{ steps.set_version.outputs.is_prerelease }}
        run: |
          npm version --no-git-tag-version "$VERSION"
          bun run copy-css-types
          git add -A
          git commit -m "ci: publish [skip ci]"
          git push

          # Create GitHub release
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            gh release create "v$VERSION" --generate-notes --prerelease
          else
            gh release create "v$VERSION" --generate-notes
          fi

      - name: Build CLI
        run: bash scripts/build-cli.sh

      - name: Publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_PAT }}
          IS_PRERELEASE: ${{ steps.set_version.outputs.is_prerelease }}
        run: |
          echo "@plaited:registry=https://registry.npmjs.org/" > .npmrc
          echo "registry=https://registry.npmjs.org/" >> .npmrc
          echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> .npmrc
          npm whoami
          npm config set registry https://registry.npmjs.org/

          # Publish with appropriate tag
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            echo "Publishing as next (prerelease)"
            npm publish --access public --tag next
          else
            echo "Publishing as latest (stable)"
            npm publish --access public
          fi
