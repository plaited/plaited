name: Claude PR Review (Internal)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  review:
    # Only run for internal contributors (org members and repo owner)
    if: |
      github.event.pull_request.author_association == 'OWNER' ||
      github.event.pull_request.author_association == 'MEMBER'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            AUTHOR: ${{ github.event.pull_request.user.login }}

            Please review this pull request from internal contributor @${{ github.event.pull_request.user.login }}.
            The PR branch is already checked out in the current working directory.

            ## Review Focus Areas

            ### Code Style & Patterns (from CLAUDE.md)
            - ✅ Prefer arrow functions over function declarations
            - ✅ Use `type` over `interface` for type definitions
            - ✅ No `any` types - use proper TypeScript types or `unknown` with type guards
            - ✅ PascalCase for types and Zod schema names
            - ✅ Use `test` instead of `it` in test files
            - ✅ Prefer `Bun.resolveSync()` over `path.join()` in Bun environments
            - ✅ Use JSX syntax - avoid `h()` or `createTemplate()` direct calls (internal functions)
            - ⚠️ Correct terminology: "templates" not "components" (except for Web Components API references)

            ### Test Files
            - `*.spec.{ts,tsx}` - Unit/integration tests (Bun test runner)
            - `*.stories.tsx` - Browser-based template tests (workshop CLI)
            - Verify tests match the file naming conventions

            ### Architecture Alignment
            - Behavioral programming patterns: proper use of `behavioral()`, `bThread()`, `bSync()`, `useBehavioral()`
            - Shadow DOM usage with `bElement`
            - CSS-in-JS patterns: proper use of  `createStyles()`, `createHostStyles()`, `createKeyframes()`, `createTokens()`, `joinStyles()`
            - Signal patterns: proper use of `useSignal()`, `useComputed()`

            ### TSDoc Standards
            - Public APIs require comprehensive TSDoc comments
            - Use `@internal` for non-public APIs
            - No `@example` sections (tests/stories serve as examples)
            - Factory functions only in behavioral documentation (never raw `yield` statements)
            - Cross-reference related APIs with `@see` tags

            ### Security & Performance
            - No security vulnerabilities (XSS, SQL injection, command injection, etc.)
            - No backwards-compatibility hacks (`_vars`, `// removed` comments)
            - Unused code should be deleted completely
            - Performance considerations for hot paths

            ## Review Instructions

            1. Use `gh pr view` and `gh pr diff` to examine the changes
            2. Focus on code quality, architecture alignment, and project-specific standards
            3. Use `mcp__github_inline_comment__create_inline_comment` for specific code issues
            4. Use `gh pr comment` for top-level feedback and summary
            5. Be constructive and specific in feedback
            6. Only post GitHub comments - don't submit review text as messages to me

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
